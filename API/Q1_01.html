<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마커 아이콘 지정 & roadView, 교통 정보</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- <script src="https:/javascript/popup_2.js"></script> -->
    <script src="key.js"></script>
    <script>
        window.onload= () => {
            const kakaoScript = document.createElement('script');
            kakaoScript.src = `http://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsKey}&autoload=false`;
            kakaoScript.onload = () => {
                kakao.maps.load(async () => {    
                    let {place,roadAddr,lat,lon} = await getCoord('경기도청');
                    drawMap(place,lat,lon);
                }); 
            };
            document.head.appendChild(kakaoScript);
        };


        async function getCoord(place){    
            try {
                const roadBaseUrl = 'https://business.juso.go.kr/addrlink/addrLinkApi.do';
                const kakaoBaseUrl = 'https://dapi.kakao.com/v2/local/search/address.json';
                const params1 = 'currentPage=1&countPerPage=5';
                const params2 = `keyword=${encodeURIComponent(place)}`;
                const params3 = `confmKey=${roadAddrKey}&resultType=json`;
                const roadUrl = `${roadBaseUrl}?${params1}&${params2}&${params3}`;

                let response = await fetch(roadUrl);   
                let result = await response.json();     
                let roadAddr = result.results.juso[0].roadAddr;

                let kakaoUrl = `${kakaoBaseUrl}?query=${encodeURIComponent(roadAddr)}`;
                let header = { Authorization: `KakaoAK ${kakaoRestKey}` };
                response = await fetch(kakaoUrl, { headers:header });
                result = await response.json();
                let lat = parseFloat(result.documents[0].y);
                let lon = parseFloat(result.documents[0].x);
                return {place,roadAddr,lat,lon};    
            } catch (error) {
                console.log(error);
                return {place, roadAddr:null, lat:null, lon:null};
            }
        }

        function drawMap(place, lat,lon){
            let container = document.getElementById('map'); 
            let position = new kakao.maps.LatLng(lat, lon);
            let options = {
                center:position,    
                level:4            
            };
            let map = new kakao.maps.Map(container, options);

            let imageSrc = 'img/경기도청_02.png';
            let imageSize = new kakao.maps.Size(80,80);
            let imageOption = {offset:new kakao.maps.Point(42,65)};

            let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            let markerPosition = new kakao.maps.LatLng(lat, lon);

            let marker = new kakao.maps.Marker({    
                map:map,           
                position:markerPosition,
                image:markerImage
            });

            let iwContent = `<div style="padding:5px;">경기도청 <br><a href="https://map.kakao.com/link/map/여기는 경기도청입니다.,${lat},${lon}" style="color:blue" target="_blank">큰지도보기</a> <a href="https://map.kakao.com/link/to/여기는 경기도청입니다.,${lat},${lon}" style="color:blue" target="_blank">길찾기</a></div>`;
            let iwPosition = new kakao.maps.LatLng(lat,lon);
            let infowindow = new kakao.maps.InfoWindow({
                position:iwPosition,
                content:iwContent
            });
            kakao.maps.event.addListener(marker,'click', ()=>{
                infowindow.open(map, marker);
            });

            // maptype에 해당하는 지도타입을 지도에 추가합니다
            map.addOverlayMapTypeId(changeMaptype);
            
            // 지도에 추가된 타입정보를 갱신합니다
            currentTypeId = changeMaptype;    
            
            
            // let roadviewContainer = document.getElementById('roadview'); //로드뷰를 표시할 div
            // let roadview = new kakao.maps.Roadview(roadviewContainer); //로드뷰 객체
            // let roadviewClient = new kakao.maps.RoadviewClient(); //좌표로부터 로드뷰 파노ID를 가져올 로드뷰 helper객체
    
            // let roadMapPosition = new kakao.maps.LatLng(lat, lon);
            
    
            // // 특정 위치의 좌표와 가까운 로드뷰의 panoId를 추출하여 로드뷰를 띄운다.
            // roadviewClient.getNearestPanoId(roadMapPosition, 50, function(panoId) {
            //     roadview.setPanoId(panoId, roadMapPosition); //panoId와 중심좌표를 통해 로드뷰 실행
            // });

        }

        // 지도에 추가된 지도타입정보를 가지고 있는 변수입니다.
        let currentTypeId;

        // 버튼이 클릭되면 호출되는 함수입니다
        function setOverlayMapTypeId(maptype) {
            let changeMaptype;
            let roadviewOverlay = new kakao.maps.RoadviewOverlay();
            
            // maptype에 따라 지도에 추가할 지도타입을 결정합니다
            if (maptype === 'traffic') {            
                
                // 교통정보 지도타입
                changeMaptype = kakao.maps.MapTypeId.TRAFFIC;     
                
            } else if (maptype === 'roadview') {        
                
                // 로드뷰 도로정보 지도타입
                changeMaptype = kakao.maps.MapTypeId.ROADVIEW;    

            } else if (maptype === 'terrain') {
                
                // 지형정보 지도타입
                changeMaptype = kakao.maps.MapTypeId.TERRAIN;    

            } else if (maptype === 'use_district') {
                
                // 지적편집도 지도타입
                changeMaptype = kakao.maps.MapTypeId.USE_DISTRICT;           
            }
            
            // 이미 등록된 지도 타입이 있으면 제거합니다
            if (currentTypeId) {
                map.removeOverlayMapTypeId(currentTypeId);    
            }
        }


        //본 예제에서는 도로명 주소 표기 방식에 대한 법령에 따라, 내려오는 데이터를 조합하여 올바른 주소를 구성하는 방법을 설명합니다.
        function sample6_execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                    // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
                    // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                    var roadAddr = data.roadAddress; // 도로명 주소 변수
                    var extraRoadAddr = ''; // 참고 항목 변수

                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraRoadAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if(extraRoadAddr !== ''){
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.getElementById('sample6_postcode').value = data.zonecode;
                    document.getElementById("sample6_roadAddress").value = roadAddr;
                    document.getElementById("sample6_jibunAddress").value = data.jibunAddress;
                    
                    // // 참고항목 문자열이 있을 경우 해당 필드에 넣는다.
                    // if(roadAddr !== ''){
                    //     document.getElementById("sample6_extraAddress").value = extraRoadAddr;
                    // } else {
                    //     document.getElementById("sample6_extraAddress").value = '';
                    // }

                    // var guideTextBox = document.getElementById("guide");
                    // // 사용자가 '선택 안함'을 클릭한 경우, 예상 주소라는 표시를 해준다.
                    // if(data.autoRoadAddress) {
                    //     var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
                    //     guideTextBox.innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';
                    //     guideTextBox.style.display = 'block';

                    // } else if(data.autoJibunAddress) {
                    //     var expJibunAddr = data.autoJibunAddress;
                    //     guideTextBox.innerHTML = '(예상 지번 주소 : ' + expJibunAddr + ')';
                    //     guideTextBox.style.display = 'block';
                    // } else {
                    //     guideTextBox.innerHTML = '';
                    //     guideTextBox.style.display = 'none';
                    // }
                }
            }).open();
        }

    </script>
</head>
<body style="margin: 40px;">
    <h1>마커 아이콘 지정</h1>
    <hr>
    <h3>경기도청</h3>
    <span id="roadAddr"></span>
    <span id="lat"></span>
    <span id="lon"></span>
    <div id="map" style="width:600px;height:400px; margin-top: 20px;"></div>
    <div style="margin-top: 15px;">
        <button onclick="setOverlayMapTypeId('traffic')">교통정보 보기</button>
        <button onclick="setOverlayMapTypeId('roadview')">로드뷰 도로정보 보기</button>
        <button onclick="setOverlayMapTypeId('terrain')">지형정보 보기</button>
        <button onclick="setOverlayMapTypeId('use_district')">지적편집도 보기</button>
    </div>
    <div style="margin-top: 15px;">
        <input type="text" id="sample6_postcode" placeholder="우편번호">
        <input type="button" onclick="sample6_execDaumPostcode()" value="우편번호 찾기"><br>
        <input type="text" id="sample6_address" placeholder="주소"><br>
        <input type="text" id="sample6_detailAddress" placeholder="상세주소">
        <input type="text" id="sample6_extraAddress" placeholder="참고항목">
    </div>
    <div id="roadview" style="width:100%;height:300px;"></div>
</body>
</html>